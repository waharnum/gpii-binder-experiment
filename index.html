<html>
    <head>
        <title>GPII Binder Experiment</title>
        <script src="src/lib/infusion/infusion-all.js"></script>
        <script src="src/lib/gpii-binder/binder.js"></script>
        <script src="src/lib/gpii-binder/codingTransforms.js"></script>
    </head>
    <body>
        <h1>GPII Binder Experiment</h1>
        <div class="gpiic-binder-form">
        </div>

    <script>

    fluid.defaults("gpii.binder.templateBinder", {
        gradeNames: ["fluid.viewComponent"],
        events: {
            onTemplatesReady: null
        },
        listeners: {
            "onTemplatesReady.appendbindingTemplate": {
                "this": "{that}.container",
                "method": "append",
                args: ["{templateLoader}.resources.bindingTemplate.resourceText"]
            },

            "onTemplatesReady.generateSelectorsFromTemplate": {
                funcName: "gpii.binder.templateBinder.generateSelectorsFromTemplate",
                args: ["{that}", "{templateLoader}.resources.bindingTemplate.resourceText"],
                priority: "after:appendbindingTemplate"
            },
            "onTemplatesReady.generateBindingsFromTemplate": {
                funcName: "gpii.binder.templateBinder.generateBindingsFromTemplate",
                args: ["{that}", "{templateLoader}.resources.bindingTemplate.resourceText"],
                priority: "after:generateSelectorsFromTemplate"
            },
            "onTemplatesReady.applyBindings": {
                "funcName": "gpii.binder.applyBinding",
                "args":     "{that}",
                priority: "after:generateBindingsFromTemplate"
            }
        },
        components: {
            templateLoader: {
                type: "fluid.resourceLoader",
                options: {
                    resources: {
                        // must be supplied by implementing grade, ex:
                        // bindingTemplate: "/src/html/template.html"
                    },
                    listeners: {
                        "onResourcesLoaded.escalate": "{gpii.binder.templateBinder}.events.onTemplatesReady"
                    }
                }
            },
        },
        bindingRuleSets: {
            // "domToModel": "modelToDom"
            "domStringToModelNumber": "fluid.transforms.stringToNumber:fluid.transforms.numberToString"
        }
    });

    // Parses an HTML template for selector-generation directives in this attribute style:
    // data-fluidSelector="[selectorName]:[jQuerySelector]
    // generates a selector option for each directive and re-inits the dom binder
    gpii.binder.templateBinder.generateSelectorsFromTemplate = function (that, template) {
        var templateSelectors = gpii.binder.templateBinder.getDirectivesFromElementAttributes(template, "data-fluidSelector");
        fluid.each(templateSelectors, function (templateSelector) {
            var selectorBlock = gpii.binder.templateBinder.getSelectorBlock(templateSelector);
            var selectorOptions = fluid.copy(that.options.selectors);
            $.extend(selectorOptions, selectorBlock);
            console.log(selectorOptions);
            that.options.selectors = selectorOptions;
        });
        // Re-init the dombinder after setting generated selectors
        fluid.initDomBinder(that, that.options.selectors);
    };

    // Parses an HTML template for binding-generation directives in this attribute style:
    // data-gpiiBinder="[selectorName]:[modelPath]/[bindingRuleKey]"
    // generates a binding option for each directive, and an optional binding rule
    gpii.binder.templateBinder.generateBindingsFromTemplate = function(that, template) {

        var templateBindings = gpii.binder.templateBinder.getDirectivesFromElementAttributes(template, "data-gpiiBinder");

        fluid.each(templateBindings, function (templateBinding) {
            var selector, modelPath, bindingRule;
            var selectorAndModelPath = templateBinding.split("/")[0];
            bindingRule = templateBinding.split("/")[1]
            selector = selectorAndModelPath.split(":")[0];
            modelPath = selectorAndModelPath.split(":")[1];

            var bindingKey = "templateBinding" + fluid.allocateGuid();

            var bindingEntry = {};

            fluid.set(bindingEntry, bindingKey, {});

            fluid.set(bindingEntry[bindingKey], "selector", selector);
            fluid.set(bindingEntry[bindingKey], "path", modelPath);

            if(bindingRule) {
                var ruleDefString = fluid.get(that.options.bindingRuleSets, bindingRule);
                var ruleObj = gpii.binder.templateBinder.getRuleBlock(ruleDefString);
                fluid.set(bindingEntry[bindingKey], "rules", ruleObj)
            }

            var bindingOptions = fluid.copy(that.options.bindings);
            $.extend(bindingOptions, bindingEntry);
            that.options.bindings = bindingOptions;
        });
    };

    gpii.binder.templateBinder.getSelectorBlock = function (selectorDefString) {
        var selectorKey = selectorDefString.split(":")[0];
        var selectorValue = selectorDefString.split(":")[1];
        var selectorBlock = {};
        fluid.set(selectorBlock, selectorKey, selectorValue);
        return selectorBlock;
    };

    gpii.binder.templateBinder.getRuleBlock = function (ruleDefString) {
        var domToModelTransformType = ruleDefString.split(":")[0];
        var modelToDomTransformType = ruleDefString.split(":")[1];
        var ruleBlock = {
            domToModel: {
                "": {
                    transform: {
                        type: domToModelTransformType,
                        inputPath: ""
                    }
                }
            },
            modelToDom: {
                "": {
                    transform: {
                        type: modelToDomTransformType,
                        inputPath: ""
                    }
                }
            }
        }

        return ruleBlock;
    }

    gpii.binder.templateBinder.getDirectivesFromElementAttributes = function (template, attributeName) {
        var elementsWithAttribute = $('*[' + attributeName + ']');
        var attributeValues = fluid.transform(elementsWithAttribute, function (element) {
            return $(element).attr(attributeName);
        });
        var uniqueElements = [];
        fluid.each(attributeValues, function (attributeValue) {
            if(! fluid.contains(uniqueElements, attributeValue)) {
                uniqueElements.push(attributeValue);
            }
        });
        return uniqueElements;

    };

    // A concrete example
    fluid.defaults("gpii.binder.templateBinder.fruitPanel", {
        gradeNames: ["gpii.binder.templateBinder"],
        selectors: {
            // Equivalent generated selectors
            // radioButtons: ".gpiic-binder-radio",
            // checkboxes: ".gpiic-binder-checkbox",
            // Equivalent selector block that should be generated from the template
            // favouriteFruit: ".gpiic-binder-favouriteFruit",
            // leastFavouriteFruit: ".gpiic-binder-leastFavouriteFruit"
        },
        model: {
            numberOfLemons: 2,
            otherFruits: ["Pears"],
            favouriteFruit: "Lemons",
            leastFavouriteFruit: "Boysenberries"
        },
        bindings: {
            // the equivalent bindings block generated from the template
            // "numberOfLemons": {
            //     selector: "radioButtons",
            //     path: "numberOfLemons",
            //     rules: {
            //         domToModel: {
            //             "": {
            //                 transform: {
            //                     type: "fluid.transforms.stringToNumber",
            //                     inputPath: ""
            //                 }
            //             }
            //         },
            //         modelToDom: {
            //             "": {
            //                 transform: {
            //                     type: "fluid.transforms.numberToString",
            //                     inputPath: ""
            //                 }
            //             }
            //         }
            //     }
            // },
            // "checkboxes": "otherFruits",
            // "favouriteFruit": "favouriteFruit",
            // "leastFavouriteFruit": "leastFavouriteFruit"
        },
        // Generic model logger
        modelListeners: {
            "*": {
                "this": "console",
                "method": "log",
                "args": ["modelChange", "{change}.path", "{change}.value"]
            }
        },
        components: {
            templateLoader: {
                options: {
                    resources: {
                        // must be supplied by implementing grade, ex:
                        bindingTemplate: "/src/html/fruitPanel-template.html"
                    }
                }
            },
        }
    });

    gpii.binder.templateBinder.fruitPanel(".gpiic-binder-form");

    </script>

    </body>
</html>
